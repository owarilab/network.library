<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>WEBサンプル</title>
<script src="/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
var ws_socket = null;
var self_connection_id = null;
var join_room_id = null;
window.onload=function()
{
	// websocketに接続
	ws_socket = new WebSocket('ws://localhost:8080');
	ws_socket.addEventListener('open', function (event) {
		// 接続完了じの最初の初期情報を送る(今は特に送る情報は無くダミー)
		// 接続IDが返ってくるのでそれを使ってroom/joinすると部屋に入れる
		ws_socket.send('dummy');
	});
	ws_socket.addEventListener('message', function (event) {
    	console.log('recv : ', event.data);
		if(self_connection_id==null){
			 // 自分を判別する接続IDが返ってくるので持っておく
			var json_data = JSON.parse(event.data);
			self_connection_id = json_data.id;

			// 部屋一覧を取得
			api_room_list(function(data){
				console.log('data : ', data);
				// 前に作った部屋があったら入る
				if(data.data.rooms.list.length>0){
					for(var i=0; i < data.data.rooms.list.length;i++){
						if(data.data.rooms.list[i].connection>=data.data.rooms.list[i].max){
							continue;
						}
						join_room_id = data.data.rooms.list[i].id;
						break;
					}
				}
				if(join_room_id==null){
					// 部屋を作る
					api_room_create("みんなの部屋",function(data){
						console.log('data : ', data);
						// 作った部屋に入る
						join_room_id = data.data.room.id;
						api_room_join(join_room_id,self_connection_id,function(data){
							console.log('data : ', data);
							ws_socket.send('新しく作った部屋に入りました');
						});
					});		
				}else{
					// listにあった空いてる部屋に入る
					api_room_join(join_room_id,self_connection_id,function(data){
						console.log('data : ', data);
						ws_socket.send('既存の部屋に入りました');
					});
				}
			});
		}
	});
}
// 共通エラー処理
function http_error_common(request, status, error){
	console.log('status : ' + status + " , error : " + error);
}
// room/join API
function api_room_join(room_id,connection_id,done)
{
	$.post( '/api/v1/room/join', {"room_id":room_id,"connection_id":connection_id} ).done( done ).fail( http_error_common );
}
// room/create API
function api_room_create(room_name,done)
{
	$.post( '/api/v1/room/create', { "name" : room_name } ).done( done ).fail( http_error_common );
}
// room/list API
function api_room_list(done)
{
	$.post( '/api/v1/room/list', {} ).done( done ).fail( http_error_common );
}
</script>
</head>
<body style="padding:0;margin:0">
</body>
</html>
